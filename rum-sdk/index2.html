<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RUM SDK Full Capture Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Simulate slow resource & CSP issues -->
  <link rel="stylesheet" href="slow-style.css" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self'; script-src 'self'">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f9fafb;
      color: #111827;
    }
    header {
      padding: 16px 24px;
      background: #111827;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    main {
      padding: 24px;
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 4px 0;
      font-size: 24px;
    }
    h2 {
      margin-top: 24px;
      margin-bottom: 8px;
      font-size: 18px;
    }
    p {
      margin-top: 0;
      margin-bottom: 8px;
      color: #4b5563;
    }
    .section {
      margin-bottom: 24px;
      padding: 16px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.1);
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      margin: 4px 8px 4px 0;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      background: #111827;
      color: white;
      transition: background 0.15s ease, transform 0.1s ease;
    }
    button:hover {
      background: #1f2937;
      transform: translateY(-1px);
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button.secondary:hover {
      background: #d1d5db;
    }
    .log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: #020617;
      color: #e5e7eb;
      padding: 12px;
      border-radius: 8px;
      max-height: 180px;
      overflow: auto;
      margin-top: 8px;
      white-space: pre-wrap;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      color: #374151;
      margin-right: 6px;
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>RUM SDK Capture Demo</h1>
    <div style="font-size:12px;opacity:.8">
      Generates all event types for your backend
    </div>
  </div>
  <div style="font-size:12px;">
    Session: <span id="session-id-pill" class="pill">-</span>
    User: <span id="user-id-pill" class="pill">-</span>
  </div>
</header>

<main>
  <div class="section">
    <h2>1. SDK & Backend Status</h2>
    <p>
      This page initializes your RUM SDK and sends events to your Spring Boot backend.
      Check DevTools â†’ Network for de>/api/rum</code> and de>/api/rum/stats/*</code> calls.
    </p>
    <button id="btn-health">Check Backend Health</button>
    <span id="health-status" class="pill">not checked</span>
    <div id="sdk-log" class="log"></div>
  </div>

  <div class="section">
    <h2>2. Generate Frontend Events</h2>
    <p>Use these buttons to trigger different event types captured by your SDK.</p>

    <div style="margin-bottom:8px;font-size:13px;color:#6b7280">
      Web vitals, page speed and engagement are captured automatically on load / unload.
    </div>

    <button id="btn-custom-event">Track Custom Event</button>
    <button id="btn-js-error">Throw JS Error</button>
    <button id="btn-unhandled-rejection">Unhandled Promise Rejection</button>
    <button id="btn-network-error">Trigger Network Error</button>
    <button id="btn-console-log" class="secondary">Console Log / Warn / Error</button>
    <button id="btn-rage-click">Rage Click Test</button>
    <button id="btn-long-task">Simulate Long Task</button>
    <button id="btn-csp-violation" class="secondary">CSP Violation</button>

    <div id="event-log" class="log"></div>
  </div>

  <div class="section">
    <h2>3. Scroll & Engagement</h2>
    <p>
      Scroll this area and stay on the page for a few seconds. When you change tab or close
      the page, the SDK should send an <strong>engagement</strong> event with time on page,
      scroll depth and interaction count.
    </p>
    <div style="height:400px;overflow:auto;border-radius:8px;border:1px solid #e5e7eb;padding:12px;background:#f3f4f6">
      <p>Scroll down to simulate real content...</p>
      <div style="height:800px;background:linear-gradient(to bottom,#e5e7eb,#f9fafb)"></div>
      <p>Bottom reached. Engagement scrollDepth should be close to 100%.</p>
    </div>
  </div>
</main>

<script type="module">
  // ---- 1. Import RUM SDK & config ----
  // Adjust paths as per your build:
  // - rum-sdk/dist/index.js (bundled) or your own output
  import { RUMWrapper } from './dist/index.js';
  import rumConfig from './rum.config.js';

  const sdkLogEl = document.getElementById('sdk-log');
  const eventLogEl = document.getElementById('event-log');
  const healthStatusEl = document.getElementById('health-status');
  const sessionPill = document.getElementById('session-id-pill');
  const userPill = document.getElementById('user-id-pill');

  function appendLog(el, msg) {
    const time = new Date().toLocaleTimeString();
    el.textContent += `[${time}] ${msg}\n`;
    el.scrollTop = el.scrollHeight;
  }

  // ---- 2. Initialize RUM SDK ----
  let rum;

  try {
    rum = new RUMWrapper({
      ...rumConfig,
      debug: true, // force debug for this demo
    });
    appendLog(sdkLogEl, 'RUMWrapper initialized.');
  } catch (e) {
    appendLog(sdkLogEl, 'Failed to initialize RUMWrapper: ' + e.message);
  }

  // Optional: set a test user
  if (rum && typeof rum.setUser === 'function') {
    const demoUserId = 'demo-user-' + Math.random().toString(36).slice(2, 8);
    rum.setUser(demoUserId, { name: 'Demo User', plan: 'free-tier' });
    userPill.textContent = demoUserId;
    appendLog(sdkLogEl, 'User set on SDK: ' + demoUserId);
  }

  // Try to expose session ID / user ID if your SDK exposes them
  try {
    if (rum && rum.sessionId) {
      sessionPill.textContent = rum.sessionId;
    }
  } catch (_) {}

  // ---- 3. Backend health check ----
  const backendBase =
    rumConfig.backendUrl?.replace(/\/api\/rum.*/, '') ||
    'http://localhost:8080';

  document.getElementById('btn-health').addEventListener('click', async () => {
    healthStatusEl.textContent = 'checking...';
    healthStatusEl.style.background = '#fbbf24';
    try {
      const res = await fetch(`${backendBase}/api/rum/health`);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      healthStatusEl.textContent = json.status || 'UP';
      healthStatusEl.style.background = '#10b981';
      appendLog(sdkLogEl, 'Backend health OK: ' + JSON.stringify(json));
    } catch (e) {
      healthStatusEl.textContent = 'DOWN';
      healthStatusEl.style.background = '#ef4444';
      appendLog(sdkLogEl, 'Backend health check failed: ' + e.message);
    }
  });

  // ---- 4. Buttons to generate events ----

  // Custom event
  document.getElementById('btn-custom-event').addEventListener('click', () => {
    if (!rum || typeof rum.trackCustomEvent !== 'function') {
      appendLog(eventLogEl, 'trackCustomEvent not available on rum instance.');
      return;
    }
    const value = Math.round(Math.random() * 1000);
    rum.trackCustomEvent('demo_button_clicked', {
      buttonId: 'btn-custom-event',
      feature: 'demo',
    }, value);
    appendLog(eventLogEl, 'Custom event sent: demo_button_clicked (' + value + ')');
  });

  // JS error
  document.getElementById('btn-js-error').addEventListener('click', () => {
    appendLog(eventLogEl, 'Throwing a JS error now...');
    // This will be caught by window error listener inside SDK
    setTimeout(() => {
      throw new Error('Demo JS error from index.html button');
    }, 0);
  });

  // Unhandled promise rejection
  document.getElementById('btn-unhandled-rejection').addEventListener('click', () => {
    appendLog(eventLogEl, 'Triggering unhandled promise rejection...');
    // No catch -> unhandledrejection
    // eslint-disable-next-line
    new Promise((_resolve, reject) => {
      setTimeout(() => reject(new Error('Demo unhandled rejection from index.html')), 0);
    });
  });

  // Network error (404 or unreachable)
  document.getElementById('btn-network-error').addEventListener('click', async () => {
    appendLog(eventLogEl, 'Triggering network error via fetch...');
    try {
      await fetch('/this-endpoint-does-not-exist-' + Date.now(), { method: 'GET' });
    } catch (e) {
      appendLog(eventLogEl, 'Fetch threw error (SDK should capture as networkError): ' + e.message);
    }
  });

  // Console logs (if SDK captures consoleLog)
  document.getElementById('btn-console-log').addEventListener('click', () => {
    console.log('[RUM DEMO] console.log message');
    console.info('[RUM DEMO] console.info message');
    console.warn('[RUM DEMO] console.warn message');
    console.error('[RUM DEMO] console.error message');
    appendLog(eventLogEl, 'console.log/info/warn/error emitted.');
  });

  // Rage click
  document.getElementById('btn-rage-click').addEventListener('click', () => {
    appendLog(eventLogEl, 'Click this button rapidly 3+ times to trigger rageClick.');
  });

  // Long task (blocks main thread > 50ms)
  document.getElementById('btn-long-task').addEventListener('click', () => {
    appendLog(eventLogEl, 'Simulating long task (~500ms busy loop)...');
    const start = performance.now();
    // Busy loop for ~500ms
    while (performance.now() - start < 500) {
      // no-op
    }
    appendLog(eventLogEl, 'Long task completed.');
  });

  // CSP violation (tries to load inline script blocked by CSP)
  document.getElementById('btn-csp-violation').addEventListener('click', () => {
    appendLog(eventLogEl, 'Attempting CSP violation (inline script)...');
    const s = document.createElement('script');
    s.textContent = "console.log('inline script should be blocked by CSP');";
    document.body.appendChild(s);
  });
</script>
</body>
</html>
